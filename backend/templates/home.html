{% extends 'base.html' %}
{% load static %}

{% block title %}PyTalk - Modern Video Conferencing{% endblock %}

{% block extra_css %}
{% if not user.is_authenticated %}
<link rel="stylesheet" href="{% static 'css/billing.css' %}">
{% endif %}
{% endblock %}

{% block content %}
<div class="container">
    <section class="hero-section fade-in">
        <h1 class="hero-title">Connect Instantly with PyTalk</h1>
        <p class="hero-subtitle">
            Crystal-clear video calls, real-time collaboration, and seamless communication.
            Built for teams who value simplicity and performance.
        </p>

        {% if user.is_authenticated %}
            <div class="d-flex gap-3 justify-content-center flex-wrap mb-5">
                <a href="{% url 'schedule_meeting' %}" class="btn btn-primary btn-lg">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    Schedule Meeting
                </a>
                <a href="{% url 'meetings_list' %}" class="btn btn-outline-primary btn-lg">
                    View My Meetings
                </a>
            </div>

            <div class="mt-5">
                <p class="text-secondary mb-3">Or join an existing meeting</p>
                <form class="meeting-join-form" id="joinForm">
                    <input type="text" class="form-control" placeholder="Enter meeting ID..." id="meetingIdInput">
                    <button type="submit" class="btn btn-primary">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                            <polyline points="10 17 15 12 10 7"/>
                            <line x1="15" y1="12" x2="3" y2="12"/>
                        </svg>
                        Join
                    </button>
                </form>
            </div>
        {% else %}
            <div class="d-flex gap-3 justify-content-center flex-wrap">
                <a href="{% url 'register' %}" class="btn btn-primary btn-lg">
                    Get Started Free
                </a>
                <a href="#pricing" class="btn btn-outline-primary btn-lg">
                    View Pricing
                </a>
            </div>
        {% endif %}
    </section>

    <section class="feature-grid fade-in">
        <div class="feature-card">
            <div class="feature-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <polygon points="23 7 16 12 23 17 23 7"/>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                </svg>
            </div>
            <h4 class="feature-title">HD Video Calls</h4>
            <p class="feature-desc">Crystal clear video quality with adaptive streaming for the best experience.</p>
        </div>

        <div class="feature-card">
            <div class="feature-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                    <line x1="8" y1="21" x2="16" y2="21"/>
                    <line x1="12" y1="17" x2="12" y2="21"/>
                </svg>
            </div>
            <h4 class="feature-title">Screen Sharing</h4>
            <p class="feature-desc">Share your screen, presentations, or specific windows with one click.</p>
        </div>

        <div class="feature-card">
            <div class="feature-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
            </div>
            <h4 class="feature-title">Real-time Chat</h4>
            <p class="feature-desc">Send messages, share links, and collaborate without interrupting the call.</p>
        </div>

        <div class="feature-card">
            <div class="feature-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polygon points="10 8 16 12 10 16 10 8"/>
                </svg>
            </div>
            <h4 class="feature-title">Meeting Recording</h4>
            <p class="feature-desc">Record meetings and download them for later review or sharing.</p>
        </div>

        <div class="feature-card">
            <div class="feature-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                    <circle cx="11" cy="11" r="2"/>
                </svg>
            </div>
            <h4 class="feature-title">Whiteboard</h4>
            <p class="feature-desc">Collaborative drawing canvas for brainstorming and visual explanations.</p>
        </div>

        <div class="feature-card">
            <div class="feature-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
            </div>
            <h4 class="feature-title">Secure & Private</h4>
            <p class="feature-desc">End-to-end encryption ensures your conversations stay private.</p>
        </div>
    </section>

    {% if not user.is_authenticated and plans %}
    <!-- Pricing Section -->
    <section class="fade-in py-5" id="pricing">
        <div class="text-center mb-5">
            <h2 class="fw-bold mb-3">Simple, transparent pricing</h2>
            <p class="text-muted fs-5">Choose the plan that fits your team</p>

            <!-- Currency Selector -->
            <div class="mt-3 mb-2">
                <label for="currencySelect" class="form-label text-muted me-2" style="font-size: 0.9rem;">Currency:</label>
                <select id="currencySelect" class="form-select form-select-sm d-inline-block" style="width: auto; background: var(--card-bg); color: var(--text-primary); border-color: var(--border-color);">
                    <option value="USD" selected>USD ($)</option>
                    <option value="INR">INR (&#8377;)</option>
                    <option value="EUR">EUR (&euro;)</option>
                    <option value="GBP">GBP (&pound;)</option>
                    <option value="SGD">SGD (S$)</option>
                    <option value="MYR">MYR (RM)</option>
                    <option value="AED">AED (&#1583;.&#1573;)</option>
                    <option value="JPY">JPY (&yen;)</option>
                </select>
            </div>

            <div class="billing-toggle mt-4">
                <span class="toggle-label active" id="monthlyLabel">Monthly</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="billingToggle">
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label" id="annualLabel">Annual <span class="save-badge">Save 20%</span></span>
            </div>
        </div>

        <div class="row g-4 justify-content-center">
            {% for plan in plans %}
            <div class="col-md-4">
                <div class="plan-card {% if plan.tier == 'pro' %}plan-featured{% endif %}">
                    {% if plan.tier == 'pro' %}
                    <div class="plan-badge">Most Popular</div>
                    {% endif %}

                    <div class="plan-header">
                        <h3 class="plan-name">{{ plan.name }}</h3>
                        <div class="plan-price">
                            <span class="price-amount monthly-price" data-tier="{{ plan.tier }}">${{ plan.monthly_price|floatformat:2 }}</span>
                            <span class="price-amount annual-price" data-tier="{{ plan.tier }}" style="display:none;">${{ plan.annual_price|floatformat:2 }}</span>
                            {% if plan.tier != 'free' %}
                            <span class="price-period monthly-period">/month{% if plan.is_per_user %}/user{% endif %}</span>
                            <span class="price-period annual-period" style="display:none;">/year{% if plan.is_per_user %}/user{% endif %}</span>
                            {% else %}
                            <span class="price-period">forever</span>
                            {% endif %}
                        </div>
                        <p class="plan-description">{{ plan.description }}</p>
                    </div>

                    <ul class="plan-features">
                        <li class="feature-item">
                            <span class="feature-check">&#10003;</span>
                            {% if plan.has_unlimited_rooms %}Unlimited rooms{% else %}{{ plan.max_rooms }} room{{ plan.max_rooms|pluralize }}{% endif %}
                        </li>
                        <li class="feature-item">
                            <span class="feature-check">&#10003;</span>
                            Up to {{ plan.max_participants }} participants
                        </li>
                        <li class="feature-item">
                            <span class="feature-check">&#10003;</span>
                            {% if plan.has_unlimited_duration %}Unlimited meeting duration{% else %}{{ plan.max_meeting_duration_minutes }}-minute meetings{% endif %}
                        </li>
                        <li class="feature-item {% if not plan.recording_enabled %}feature-disabled{% endif %}">
                            <span class="feature-check">{% if plan.recording_enabled %}&#10003;{% else %}&#10007;{% endif %}</span>
                            Meeting recording
                        </li>
                        <li class="feature-item {% if not plan.custom_branding %}feature-disabled{% endif %}">
                            <span class="feature-check">{% if plan.custom_branding %}&#10003;{% else %}&#10007;{% endif %}</span>
                            Custom branding
                        </li>
                        {% if plan.tier == 'business' %}
                        <li class="feature-item">
                            <span class="feature-check">&#10003;</span>
                            Custom subdomain
                        </li>
                        <li class="feature-item">
                            <span class="feature-check">&#10003;</span>
                            Breakout rooms
                        </li>
                        <li class="feature-item">
                            <span class="feature-check">&#10003;</span>
                            Waiting rooms
                        </li>
                        {% endif %}
                    </ul>

                    <div class="plan-action">
                        {% if plan.tier == 'free' %}
                            <a href="{% url 'register' %}" class="btn btn-outline-primary w-100">Get Started Free</a>
                        {% elif payu_enabled %}
                            <a href="{% url 'register' %}?plan={{ plan.tier }}&cycle=monthly" class="btn btn-primary w-100 signup-btn" data-tier="{{ plan.tier }}">
                                Get {{ plan.name }}
                            </a>
                        {% else %}
                            <button class="btn btn-secondary w-100" disabled>Coming Soon</button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <footer class="text-center py-5 mt-5">
    </footer>
</div>

<script>
document.getElementById('joinForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const meetingId = document.getElementById('meetingIdInput').value.trim();
    if (meetingId) {
        window.location.href = '/meeting/startmeeting/' + meetingId + '/';
    }
});

// Billing toggle and currency selector for landing page pricing section
(function() {
    var toggle = document.getElementById('billingToggle');
    var currencySelect = document.getElementById('currencySelect');

    if (toggle) {
        toggle.addEventListener('change', function() {
            var isAnnual = this.checked;
            document.querySelectorAll('.monthly-price').forEach(function(el) { el.style.display = isAnnual ? 'none' : ''; });
            document.querySelectorAll('.annual-price').forEach(function(el) { el.style.display = isAnnual ? '' : 'none'; });
            document.querySelectorAll('.monthly-period').forEach(function(el) { el.style.display = isAnnual ? 'none' : ''; });
            document.querySelectorAll('.annual-period').forEach(function(el) { el.style.display = isAnnual ? '' : 'none'; });

            document.querySelectorAll('.signup-btn').forEach(function(btn) {
                var tier = btn.getAttribute('data-tier');
                var cycle = isAnnual ? 'annual' : 'monthly';
                btn.href = '/user/register/?plan=' + tier + '&cycle=' + cycle;
            });

            document.getElementById('monthlyLabel').classList.toggle('active', !isAnnual);
            document.getElementById('annualLabel').classList.toggle('active', isAnnual);
        });
    }

    if (currencySelect) {
        currencySelect.addEventListener('change', function() {
            var currency = this.value;
            document.cookie = 'preferred_currency=' + currency + ';path=/;max-age=31536000';
            fetch('/billing/api/currency-rates/?currency=' + currency)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.error) return;
                    var plans = data.plans;
                    for (var tier in plans) {
                        var prices = plans[tier];
                        document.querySelectorAll('.monthly-price[data-tier="' + tier + '"]').forEach(function(el) {
                            el.textContent = prices.monthly;
                        });
                        document.querySelectorAll('.annual-price[data-tier="' + tier + '"]').forEach(function(el) {
                            el.textContent = prices.annual;
                        });
                    }
                });
        });
    }
})();
</script>
{% endblock %}
