{% extends 'base.html' %}

{% block title %}Get Started - PyTalk{% endblock %}

{% block extra_css %}
<style>
    .auth-wrapper {
        min-height: calc(100vh - 160px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
        position: relative;
    }

    /* Subtle ambient glow behind the card */
    .auth-wrapper::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 600px;
        height: 600px;
        transform: translate(-50%, -50%);
        background: radial-gradient(circle, rgba(99, 102, 241, 0.08) 0%, rgba(167, 139, 250, 0.04) 40%, transparent 70%);
        pointer-events: none;
        z-index: 0;
    }

    .auth-card {
        width: 100%;
        max-width: 480px;
        position: relative;
        z-index: 1;
    }

    .auth-card .card {
        border-radius: var(--radius-xl, 24px);
    }

    .auth-card .card-header {
        background: transparent;
        border-bottom: 1px solid var(--border-color);
        padding: 2rem 2rem 1.5rem;
    }

    .auth-card .card-header h3 {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: -0.02em;
        margin-bottom: 0.375rem;
    }

    .auth-card .card-body {
        padding: 2rem;
    }

    .auth-card .form-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-secondary);
    }

    .auth-card .btn-lg {
        padding: 0.875rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        border-radius: var(--radius-md, 12px);
    }

    .auth-footer-link {
        font-size: 0.9rem;
    }

    .auth-footer-link a {
        font-weight: 600;
    }

    .plan-selected-badge {
        display: inline-block;
        background: linear-gradient(135deg, #6366f1, #a855f7);
        font-size: 0.85rem;
        padding: 6px 16px;
        border-radius: var(--radius-sm, 8px);
        color: #fff;
        font-weight: 600;
    }

    .auth-divider {
        border-color: var(--border-color);
        opacity: 1;
        margin: 1.25rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-wrapper">
    <div class="auth-card fade-in">
        <div class="card glass-card">
            <div class="card-header text-center">
                <h3>Create your account</h3>
                {% if selected_plan_obj %}
                <p class="mb-0 mt-2">
                    <span class="plan-selected-badge">
                        {{ selected_plan_obj.name }} Plan &mdash;
                        {% if selected_cycle == 'annual' %}
                            ${{ selected_plan_obj.annual_price|floatformat:2 }}/yr{% if selected_plan_obj.is_per_user %}/user{% endif %}
                        {% else %}
                            ${{ selected_plan_obj.monthly_price|floatformat:2 }}/mo{% if selected_plan_obj.is_per_user %}/user{% endif %}
                        {% endif %}
                    </span>
                </p>
                {% else %}
                <p class="text-secondary mb-0" style="font-size: 0.95rem;">Join PyTalk and start connecting</p>
                {% endif %}
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    {% if selected_plan %}
                    <input type="hidden" name="selected_plan" value="{{ selected_plan }}">
                    <input type="hidden" name="selected_cycle" value="{{ selected_cycle }}">
                    {% endif %}
                    <div class="mb-3">
                        <label for="id_username" class="form-label">Username</label>
                        {{ form.username }}
                        {% if form.username.errors %}
                            <small class="text-danger">{{ form.username.errors.0 }}</small>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="id_email" class="form-label">Email</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <small class="text-danger">{{ form.email.errors.0 }}</small>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="id_password1" class="form-label">Password</label>
                        {{ form.password1 }}
                        {% if form.password1.errors %}
                            <small class="text-danger">{{ form.password1.errors.0 }}</small>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="id_password2" class="form-label">Confirm Password</label>
                        {{ form.password2 }}
                        {% if form.password2.errors %}
                            <small class="text-danger">{{ form.password2.errors.0 }}</small>
                        {% endif %}
                    </div>
                    <hr class="auth-divider">
                    <div class="mb-3">
                        <label for="organization_name" class="form-label">Organization Name <span class="text-muted">(optional)</span></label>
                        <input type="text" class="form-control" id="organization_name" name="organization_name"
                               placeholder="e.g., Acme Inc." value="{{ organization_name_value }}">
                        <div class="form-text" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.375rem;">Create a new organization or leave blank for a personal workspace.</div>
                    </div>
                    {% if selected_plan == 'business' %}
                    <div class="mb-4" id="subdomainField" style="display: none;">
                        <label for="subdomain" class="form-label">Your Subdomain</label>
                        <div class="input-group">
                            <span class="input-group-text" style="background: var(--bg-primary); border-color: var(--glass-border); color: var(--text-muted); font-size: 0.9rem; border-radius: var(--radius-md, 12px) 0 0 var(--radius-md, 12px);">https://</span>
                            <input type="text" class="form-control" id="subdomain" name="subdomain"
                                   placeholder="acme" pattern="^[a-z0-9][a-z0-9-]*[a-z0-9]$|^[a-z0-9]$" value="{{ subdomain_value }}">
                            <span class="input-group-text" style="background: var(--bg-primary); border-color: var(--glass-border); color: var(--text-muted); font-size: 0.9rem; border-radius: 0 var(--radius-md, 12px) var(--radius-md, 12px) 0;">.pytalk.veriright.com</span>
                        </div>
                        <div class="form-text" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.375rem;">Your team will access meetings at this URL. Only lowercase letters, numbers, and hyphens.</div>
                        {% if subdomain_error %}
                        <small class="text-danger">{{ subdomain_error }}</small>
                        {% endif %}
                    </div>
                    <script>
                    (function() {
                        var orgInput = document.getElementById('organization_name');
                        var subdomainField = document.getElementById('subdomainField');
                        var subdomainInput = document.getElementById('subdomain');

                        function generateSlug(name) {
                            return name.toLowerCase()
                                .replace(/[^a-z0-9\s-]/g, '')
                                .replace(/\s+/g, '-')
                                .replace(/-+/g, '-')
                                .replace(/^-|-$/g, '')
                                .substring(0, 30);
                        }

                        function updateSubdomain() {
                            var name = orgInput.value.trim();
                            if (name) {
                                subdomainField.style.display = 'block';
                                if (!subdomainInput.dataset.userEdited) {
                                    subdomainInput.value = generateSlug(name);
                                }
                            } else {
                                subdomainField.style.display = 'none';
                            }
                        }

                        orgInput.addEventListener('input', updateSubdomain);
                        subdomainInput.addEventListener('input', function() {
                            this.dataset.userEdited = 'true';
                            this.value = this.value.toLowerCase().replace(/[^a-z0-9-]/g, '');
                        });

                        // Show on page load if org name exists
                        updateSubdomain();
                    })();
                    </script>
                    {% endif %}
                    <div class="d-grid mb-4">
                        <button type="submit" class="btn btn-primary btn-lg">Create Account</button>
                    </div>
                </form>
                <div class="text-center auth-footer-link">
                    <span class="text-secondary">Already have an account?</span>
                    {% if selected_plan %}
                    <a href="{% url 'login' %}?next=/billing/checkout/{{ selected_plan }}/{{ selected_cycle }}/" class="ms-1">Sign in</a>
                    {% else %}
                    <a href="{% url 'login' %}" class="ms-1">Sign in</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
